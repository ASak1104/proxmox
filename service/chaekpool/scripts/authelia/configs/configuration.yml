---
# Authelia Configuration
# 플레이스홀더(__XXX__)는 deploy.sh에서 sed로 치환

server:
  address: "tcp://0.0.0.0:9091"

log:
  level: "info"
  file_path: "/var/log/authelia/authelia.log"

identity_validation:
  reset_password:
    jwt_secret: "__JWT_SECRET__"

authentication_backend:
  file:
    path: "/etc/authelia/users_database.yml"
    password:
      algorithm: "argon2id"

access_control:
  default_policy: "deny"
  rules:
    # Kopring API — 자체 인증
    - domain: "api.cp.codingmon.dev"
      policy: "bypass"
    # Authelia 포탈 자체
    - domain: "authelia.cp.codingmon.dev"
      policy: "bypass"
    # 나머지 *.cp.codingmon.dev — 1단계 인증
    - domain: "*.cp.codingmon.dev"
      policy: "one_factor"

session:
  secret: "__SESSION_SECRET__"
  cookies:
    - domain: "cp.codingmon.dev"
      authelia_url: "https://authelia.cp.codingmon.dev"
      default_redirection_url: "https://grafana.cp.codingmon.dev"

storage:
  encryption_key: "__STORAGE_ENCRYPTION_KEY__"
  local:
    path: "/var/lib/authelia/db.sqlite3"

notifier:
  filesystem:
    filename: "/var/lib/authelia/notification.txt"

identity_providers:
  oidc:
    hmac_secret: "__OIDC_HMAC_SECRET__"
    jwks:
      - key_id: "main"
        algorithm: "RS256"
        use: "sig"
        key: {{ secret "/etc/authelia/oidc.jwks.rsa.4096.pem" | mindent 10 "|" }}
    clients:
      - client_id: "grafana"
        client_name: "Grafana"
        client_secret: "__OIDC_GRAFANA_HASH__"
        authorization_policy: "one_factor"
        require_pkce: true
        pkce_challenge_method: "S256"
        redirect_uris:
          - "https://grafana.cp.codingmon.dev/login/generic_oauth"
        scopes:
          - "openid"
          - "profile"
          - "email"
          - "groups"
        token_endpoint_auth_method: "client_secret_basic"

      - client_id: "jenkins"
        client_name: "Jenkins"
        client_secret: "__OIDC_JENKINS_HASH__"
        authorization_policy: "one_factor"
        require_pkce: false
        redirect_uris:
          - "https://jenkins.cp.codingmon.dev/securityRealm/finishLogin"
        scopes:
          - "openid"
          - "offline_access"
          - "profile"
          - "email"
          - "groups"
          - "address"
          - "phone"
        token_endpoint_auth_method: "client_secret_basic"

      - client_id: "pgadmin"
        client_name: "pgAdmin"
        client_secret: "__OIDC_PGADMIN_HASH__"
        authorization_policy: "one_factor"
        require_pkce: false
        redirect_uris:
          - "https://postgres.cp.codingmon.dev/oauth2/authorize"
        scopes:
          - "openid"
          - "profile"
          - "email"
        token_endpoint_auth_method: "client_secret_basic"
